<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SkillBridge - Advanced Skill Analytics</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="roles-config.js"></script>
  <style>
    .skills-analytics {
      background: transparent;
      padding: 0;
    }

    .analytics-hero {
      text-align: center;
      margin-bottom: 32px;
      padding: 28px 24px;
      background: #161b22;
      border-radius: 12px;
      border: 1px solid #30363d;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .analytics-hero h1 {
      color: #e6edf3;
      font-size: 1.75rem;
      margin-bottom: 8px;
    }

    .analytics-hero p {
      color: #8b949e;
      font-size: 1rem;
      margin-bottom: 0;
    }

    .analytics-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .analytics-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }

    .analytics-card:hover {
      border-color: #58a6ff;
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.25);
    }

    .analytics-card h3 {
      color: #e6edf3;
      font-size: 1.15rem;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #30363d;
    }

    .analytics-card canvas {
      max-height: 320px;
    }

    .chart-wrapper {
      position: relative;
      height: 320px;
      width: 100%;
    }

    .insights-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .insights-card h4 {
      color: #58a6ff;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #30363d;
      font-size: 1.1em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .insights-card p {
      color: #c9d1d9;
      line-height: 1.7;
      margin-bottom: 12px;
    }

    .opportunity-badge {
      display: inline-block;
      background: #21262d;
      color: #58a6ff;
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.85em;
      margin-right: 8px;
      margin-bottom: 8px;
      border: 1px solid #30363d;
    }

    .skill-meter {
      background: #21262d;
      height: 8px;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 10px;
      border: 1px solid #30363d;
    }

    .skill-meter-fill {
      background: #58a6ff;
      height: 100%;
      transition: width 0.4s ease;
    }

    .skill-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      color: #c9d1d9;
      font-weight: 500;
      font-size: 0.9em;
    }

    .domain-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .domain-btn {
      padding: 10px 20px;
      background: #21262d;
      border: 1px solid #30363d;
      color: #8b949e;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .domain-btn:hover,
    .domain-btn.active {
      background: #161b22;
      color: #58a6ff;
      border-color: #58a6ff;
    }

    .career-pathways {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }

    .pathway-card {
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 18px;
      transition: all 0.2s ease;
    }

    .pathway-card:hover {
      border-color: #58a6ff;
    }

    .pathway-card h5 {
      color: #e6edf3;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    .pathway-card p {
      color: #8b949e;
      font-size: 0.875em;
      margin-bottom: 8px;
    }

    .match-score {
      display: inline-block;
      background: rgba(88, 166, 255, 0.2);
      color: #58a6ff;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.8em;
    }

    .full-width-section {
      background: #161b22;
      border-radius: 12px;
      border: 1px solid #30363d;
      padding: 28px 32px;
      margin-top: 32px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .full-width-section h2 {
      color: #e6edf3;
      font-size: 1.35rem;
      margin-bottom: 24px;
      text-align: center;
      padding-bottom: 12px;
      border-bottom: 1px solid #30363d;
    }

    @media (max-width: 768px) {
      .analytics-grid {
        grid-template-columns: 1fr;
      }

      .analytics-hero h1 {
        font-size: 2em;
      }

      .analytics-hero p {
        font-size: 1em;
      }
    }
  </style>
</head>

<body>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) sidebar.classList.remove('hide');
    });
  </script>

  <div class="app">
    <!-- Sidebar: 5 sections (same on all pages) -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2 class="logo">SkillBridge</h2>
        <button class="close-btn" onclick="closeSidebar()">‚úñ</button>
      </div>
      <nav>
        <button onclick="window.location.href='index.html'" title="Dashboard">üìä Dashboard</button>
        <button class="active" onclick="window.location.href='skills-analysis.html'" title="Skill Analysis">üß† Skill Analysis</button>
        <button onclick="window.location.href='roadmap.html'" title="Career Roadmap">üõ£Ô∏è Career Roadmap</button>
        <button onclick="window.location.href='internships.html'" title="Internships & Projects">üöÄ Internships & Projects</button>
        <button onclick="window.location.href='resume.html'" title="Resume Tracker">üìÑ Resume Tracker</button>
      </nav>
    </aside>

    <div class="main">
      <header class="navbar">
        <div style="display: flex; gap: 10px; align-items: center;">
          <button class="back-btn" onclick="window.history.back()" title="Go back">‚Üê Back</button>
          <button class="menu-btn" onclick="openSidebar()">‚ò∞</button>
        </div>
        <h1 id="pageTitle">Skill Analytics</h1>
        <div class="profile" onclick="logout()" style="cursor: pointer;">üë§ Student</div>
      </header>

      <main class="content">
        <div class="skills-analytics">
          <div class="analytics-hero">
            <h1>üß† Skill-to-Career Analytics</h1>
            <p>Based on <strong>your profile skills</strong>. Complete your profile to see personalized analysis and skill gaps per role.</p>
          </div>

          <div class="analytics-container">
            <!-- Role Selector (all roles ‚Äì same as Profile & Career Roadmap) -->
            <div style="text-align: center; margin-bottom: 40px;">
              <h2 style="color: #3B82F6; margin-bottom: 20px;">Select Role for Skill Gap Analysis</h2>
              <div class="domain-selector" id="roleSelector"></div>
            </div>

            <!-- Analytics Charts -->
            <div class="analytics-grid">
              <!-- Skill Proficiency Radar -->
              <div class="analytics-card">
                <h3>üí° Skill Proficiency Profile</h3>
                <div class="chart-wrapper">
                  <canvas id="radarChart"></canvas>
                </div>
              </div>

              <!-- Career Match Analysis -->
              <div class="analytics-card">
                <h3>üéØ Career Match Analysis</h3>
                <div class="chart-wrapper">
                  <canvas id="careerMatchChart"></canvas>
                </div>
              </div>

              <!-- Skill Gap Analysis -->
              <div class="analytics-card">
                <h3>üìà Skill Gap vs Industry Standard</h3>
                <div class="chart-wrapper">
                  <canvas id="skillGapChart"></canvas>
                </div>
              </div>

              <!-- Market Demand -->
              <div class="analytics-card">
                <h3>üöÄ Market Demand Trends</h3>
                <div class="chart-wrapper">
                  <canvas id="demandChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Insights Section -->
            <div class="full-width-section">
              <h2>üîç Key Insights & Recommendations</h2>

              <div class="insights-card" id="yourProfileCard">
                <h4>üìå Your Skills (from Profile)</h4>
                <p id="noProfileMsg" style="color: #9CA3AF;">Complete your profile with skills to see personalized analysis.</p>
                <div id="userSkillsMeters" style="margin-bottom: 20px;"></div>
              </div>

              <div class="insights-card" id="skillGapCard">
                <h4>üìâ Skill Gap for <span id="selectedRoleTitle">Selected Role</span></h4>
                <p id="skillGapDesc">For the selected role, skills you need to improve to reach industry level (80).</p>
                <div id="skillGapList"></div>
              </div>

              <div class="insights-card">
                <h4>üíº Top Career Matches (by your skills)</h4>
                <div id="careerOpportunities"></div>
              </div>

              <div class="insights-card">
                <h4>üéì Recommended Learning Path</h4>
                <p>Focus on closing the largest skill gaps first. Use the Career Roadmap for step-by-step guidance.</p>
                <p style="margin-top: 10px;"><a href="roadmap.html" style="color: #22D3EE;">View Career Roadmap ‚Üí</a></p>
              </div>

              <!-- Career Pathways (all roles with match %) -->
              <div style="margin-top: 40px;">
                <h3 style="color: #22D3EE; margin-bottom: 25px;">üåü All Roles (same as Profile & Roadmap)</h3>
                <div class="career-pathways" id="careerPathways"></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCgffF2_yiVYND2pl4j3-JJezYrI0Gzw7I",
      authDomain: "skill-bridge-92cff.firebaseapp.com",
      projectId: "skill-bridge-92cff",
      storageBucket: "skill-bridge-92cff.firebasestorage.app",
      messagingSenderId: "379886840265",
      appId: "1:379886840265:web:f73b1fc51080a2b7ace018",
      measurementId: "G-JKWNG1Y836"
    };

    firebase.initializeApp(firebaseConfig);
    window.auth = firebase.auth();
    window.db = firebase.firestore();

    let currentRoleId = (typeof ALL_ROLES !== 'undefined' && ALL_ROLES[0]) ? ALL_ROLES[0].id : 'frontend';
    let charts = {};
    let userProfile = { skills: {} };

    function loadUserProfile() {
      const saved = localStorage.getItem('userProfile');
      if (saved) {
        try {
          userProfile = JSON.parse(saved);
          if (!userProfile.skills) userProfile.skills = {};
        } catch (e) { userProfile = { skills: {} }; }
      }
    }

    function renderRoleSelector() {
      const el = document.getElementById('roleSelector');
      if (!el || typeof ALL_ROLES === 'undefined') return;
      el.innerHTML = ALL_ROLES.map(r =>
        `<button class="domain-btn ${r.id === currentRoleId ? 'active' : ''}" onclick="selectRole('${r.id}')">${r.title}</button>`
      ).join('');
    }

    function selectRole(roleId) {
      currentRoleId = roleId;
      document.querySelectorAll('.domain-btn').forEach(btn => btn.classList.remove('active'));
      const btn = document.querySelector(`.domain-btn[onclick="selectRole('${roleId}')"]`);
      if (btn) btn.classList.add('active');
      updateAllCharts();
      updateInsights();
    }

    function updateAllCharts() {
      loadUserProfile();
      const role = typeof ALL_ROLES !== 'undefined' && ALL_ROLES.find(r => r.id === currentRoleId);
      const userSkills = userProfile.skills || {};
      const roleSkills = role ? role.requiredSkills : [];
      const labels = roleSkills.length ? roleSkills : Object.keys(userSkills).slice(0, 8);
      const userLevels = labels.map(s => typeof getUserLevelForSkill === 'function' ? getUserLevelForSkill(userSkills, s) : (userSkills[s] || 0));
      const industryLevels = labels.map(() => 80);

      updateRadarChart(labels, userLevels, industryLevels);
      const matchPercents = typeof ALL_ROLES !== 'undefined' ? ALL_ROLES.map(r => getRoleMatchPercent(r, userSkills)) : [];
      updateCareerMatchChart(matchPercents);
      updateSkillGapChart(labels, userLevels, industryLevels);
      updateDemandChart(labels, userLevels);
    }

    function updateRadarChart(labels, userLevels, industryLevels) {
      const ctx = document.getElementById('radarChart');
      if (!ctx) return;
      if (charts.radar) charts.radar.destroy();
      if (labels.length === 0) { ctx.parentElement.innerHTML = '<p style="color:#9CA3AF;">Add skills in your profile to see this chart.</p>'; return; }
      charts.radar = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Your Skills',
            data: userLevels,
            borderColor: '#22D3EE',
            backgroundColor: 'rgba(255, 0, 110, 0.15)',
            borderWidth: 2,
            fill: true,
            pointBackgroundColor: '#3B82F6',
            pointBorderColor: '#22D3EE',
            pointRadius: 6,
            pointHoverRadius: 8
          }, {
            label: 'Industry Standard',
            data: industryLevels,
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(57, 255, 20, 0.05)',
            borderWidth: 2,
            fill: true,
            pointBackgroundColor: '#22D3EE',
            borderDash: [5, 5]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { legend: { labels: { color: '#f0f0f0', font: { size: 12 } } } },
          scales: { r: { grid: { color: 'rgba(255, 0, 110, 0.2)' }, ticks: { color: '#f0f0f0', backdropColor: 'transparent' } } }
        }
      });
    }

    function updateCareerMatchChart(matchPercents) {
      const ctx = document.getElementById('careerMatchChart');
      if (!ctx) return;
      if (charts.careerMatch) charts.careerMatch.destroy();
      const roles = typeof ALL_ROLES !== 'undefined' ? ALL_ROLES : [];
      if (roles.length === 0) return;
      charts.careerMatch = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: roles.map(r => r.title),
          datasets: [{
            data: matchPercents.length ? matchPercents : roles.map(() => 50),
            backgroundColor: ['#22D3EE', '#3B82F6', '#34F5C5', '#FF6B6B', '#FFE66D', '#95E1D3', '#F38181', '#AA96DA', '#FCBAD3', '#A8D8EA', '#FF9A8B', '#FAD0C4', '#D4A5A5'],
            borderColor: '#0d0d0d',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#f0f0f0', boxWidth: 12 } } }
        }
      });
    }

    function updateSkillGapChart(labels, userLevels, industryLevels) {
      const ctx = document.getElementById('skillGapChart');
      if (!ctx) return;
      if (charts.skillGap) charts.skillGap.destroy();
      if (labels.length === 0) { ctx.parentElement.innerHTML = '<p style="color:#9CA3AF;">Select a role to see skill gap.</p>'; return; }
      charts.skillGap = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'Your Level', data: userLevels, backgroundColor: 'rgba(255, 0, 110, 0.7)', borderColor: '#22D3EE', borderWidth: 2 },
            { label: 'Industry Standard', data: industryLevels, backgroundColor: 'rgba(57, 255, 20, 0.7)', borderColor: '#3B82F6', borderWidth: 2 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#f0f0f0' } } },
          scales: {
            y: { beginAtZero: true, max: 100, ticks: { color: '#f0f0f0' }, grid: { color: 'rgba(255, 0, 110, 0.2)' } },
            x: { ticks: { color: '#f0f0f0', maxRotation: 45 }, grid: { color: 'rgba(255, 0, 110, 0.1)' } }
          }
        }
      });
    }

    function updateDemandChart(labels, levels) {
      const ctx = document.getElementById('demandChart');
      if (!ctx) return;
      if (charts.demand) charts.demand.destroy();
      if (labels.length === 0) return;
      charts.demand = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Your Level',
            data: levels,
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(57, 255, 20, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#22D3EE',
            pointBorderColor: '#3B82F6',
            pointRadius: 6,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#f0f0f0' } }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { color: '#f0f0f0' },
              grid: { color: 'rgba(57, 255, 20, 0.2)' }
            },
            x: {
              ticks: { color: '#f0f0f0' },
              grid: { color: 'rgba(57, 255, 20, 0.1)' }
            }
          }
        }
      });
    }

    function updateInsights() {
      loadUserProfile();
      const userSkills = userProfile.skills || {};
      const role = typeof ALL_ROLES !== 'undefined' && ALL_ROLES.find(r => r.id === currentRoleId);
      const roleTitle = role ? role.title : 'Selected Role';

      const titleEl = document.getElementById('selectedRoleTitle');
      if (titleEl) titleEl.textContent = roleTitle;

      const noMsg = document.getElementById('noProfileMsg');
      const metersEl = document.getElementById('userSkillsMeters');
      if (Object.keys(userSkills).length === 0) {
        if (noMsg) noMsg.style.display = 'block';
        if (metersEl) metersEl.innerHTML = '';
      } else {
        if (noMsg) noMsg.style.display = 'none';
        if (metersEl) {
          metersEl.innerHTML = Object.entries(userSkills).slice(0, 8).map(([name, level]) =>
            '<div class="skill-label"><span>' + name + '</span><span>' + level + '%</span></div>' +
            '<div class="skill-meter"><div class="skill-meter-fill" style="width: ' + level + '%"></div></div>'
          ).join('');
        }
      }

      const gapList = document.getElementById('skillGapList');
      if (gapList && role && typeof getSkillGapForRole === 'function') {
        const gaps = getSkillGapForRole(role, userSkills, 80);
        gapList.innerHTML = gaps.length ? gaps.map(g =>
          '<div style="margin: 10px 0; padding: 10px; background: rgba(45,212,191,0.1); border-radius: 6px; border-left: 3px solid ' + (g.gap > 40 ? '#ff6b6b' : '#22D3EE') + ';">' +
          '<strong>' + g.skill + '</strong>: Your level ' + g.userLevel + '/' + g.targetLevel + ' ‚Äî Gap: ' + g.gap + ' points</div>'
        ).join('') : '<p style="color:#9CA3AF;">No required skills defined for this role.</p>';
      } else if (gapList) gapList.innerHTML = '<p style="color:#9CA3AF;">Select a role and add skills in profile.</p>';

      const oppEl = document.getElementById('careerOpportunities');
      if (oppEl && typeof ALL_ROLES !== 'undefined' && typeof getRoleMatchPercent === 'function') {
        const withMatch = ALL_ROLES.map(r => ({ ...r, match: getRoleMatchPercent(r, userSkills) })).sort((a, b) => b.match - a.match);
        oppEl.innerHTML = withMatch.slice(0, 6).map(c =>
          '<div class="opportunity-badge">' + c.title + ' (' + c.match + '% Match)</div>'
        ).join('');
      }

      const pathwaysEl = document.getElementById('careerPathways');
      if (pathwaysEl && typeof ALL_ROLES !== 'undefined' && typeof getRoleMatchPercent === 'function') {
        const withMatch = ALL_ROLES.map(r => ({ ...r, match: getRoleMatchPercent(r, userSkills) })).sort((a, b) => b.match - a.match);
        pathwaysEl.innerHTML = withMatch.map(r =>
          '<div class="pathway-card">' +
          '<h5>üíº ' + r.title + '</h5>' +
          '<p>Path: ' + r.path + '</p>' +
          '<p>Outcome: <strong>' + r.outcome + '</strong></p>' +
          '<p>Match: <span class="match-score">' + r.match + '%</span></p>' +
          '<a href="detailed-roadmap.html?domain=' + r.id + '" style="color: #22D3EE; font-size: 0.9em;">View Detailed Roadmap ‚Üí</a>' +
          '</div>'
        ).join('');
      }
    }

    function navigateTo(page) {
      window.location.href = page;
    }

    function openSidebar() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) sidebar.classList.remove('hide');
    }

    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) sidebar.classList.add('hide');
    }

    function logout() {
      window.auth.signOut().then(() => {
        window.location.href = 'login.html';
      });
    }

    // Initialize on page load: use profile from localStorage (same as Dashboard/Profile)
    window.addEventListener('load', () => {
      loadUserProfile();
      renderRoleSelector();
      updateAllCharts();
      updateInsights();
      window.auth.onAuthStateChanged(user => {
        if (user) {
          loadUserProfile();
          updateAllCharts();
          updateInsights();
        }
      });
    });
  </script>
</body>

</html>